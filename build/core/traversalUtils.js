'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getImportedFilePaths = exports.eliminateGlobals = exports.getParentSelectorClassesMap = exports.getExtendClassesMap = exports.getComposesClassesMap = exports.getRegularClassesMap = undefined;

var _fp = require('lodash/fp');

var _fp2 = _interopRequireDefault(_fp);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-param-reassign */
var getRegularClassesMap = exports.getRegularClassesMap = function getRegularClassesMap(ast) {
  var ruleSets = [];
  ast.traverseByType('ruleset', function (node) {
    return ruleSets.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    result[key] = false; // classes haven't been used
    return result;
  }, {}), _fp2.default.map('content'), _fp2.default.filter({ type: 'ident' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'class' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'selector' }), _fp2.default.flatMap('content'))(ruleSets);
};

var getComposesClassesMap = exports.getComposesClassesMap = function getComposesClassesMap(ast) {
  var declarations = [];
  ast.traverseByType('declaration', function (node) {
    return declarations.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    result[key] = true; // mark composed classes as true
    return result;
  }, {}), _fp2.default.flatMap(_fp2.default.compose(_fp2.default.map(_fp2.default.get('content')), _fp2.default.filter({ type: 'ident' }), _fp2.default.get('content'), _fp2.default.find({ type: 'value' }), _fp2.default.get('content'))),
  /*
     reject classes composing from other files
     eg.
     .foo {
     composes: .bar from './otherFile';
     }
   */
  _fp2.default.reject(_fp2.default.compose(_fp2.default.find({ type: 'ident', content: 'from' }), _fp2.default.get('content'), _fp2.default.find({ type: 'value' }), _fp2.default.get('content'))), _fp2.default.filter(_fp2.default.compose(_fp2.default.find({ type: 'ident', content: 'composes' }), _fp2.default.get('content'), _fp2.default.find({ type: 'property' }), _fp2.default.get('content'))))(declarations);
};

var getExtendClassesMap = exports.getExtendClassesMap = function getExtendClassesMap(ast) {
  var extendNodes = [];
  ast.traverseByType('extend', function (node) {
    return extendNodes.push(node);
  });

  return _fp2.default.compose(_fp2.default.reduce(function (result, key) {
    result[key] = true; // mark extend classes as true
    return result;
  }, {}), _fp2.default.map(_fp2.default.compose(_fp2.default.get('content'), _fp2.default.find({ type: 'ident' }), _fp2.default.get('content'), _fp2.default.find({ type: 'class' }), _fp2.default.get('content'), _fp2.default.find({ type: 'selector' }), _fp2.default.get('content'))))(extendNodes);
};

/**
 * Resolves parent selectors to their full class names.
 *
 * E.g. `.foo { &_bar {color: blue } }` to `.foo_bar`.
 */
var getParentSelectorClassesMap = exports.getParentSelectorClassesMap = function getParentSelectorClassesMap(ast) {
  var classesMap = {};

  // Recursively traverses down the tree looking for parent selector
  // extensions. Recursion is necessary as these selectors can be nested.
  var getExtensions = function getExtensions(nodeContent) {
    var blockContent = _fp2.default.compose(_fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }))(nodeContent);

    var rulesetsContent = _fp2.default.flatMap('content', _fp2.default.concat(
    // `ruleset` children
    _fp2.default.filter({ type: 'ruleset' }, blockContent),

    // `ruleset` descendants nested in `include` nodes
    _fp2.default.compose(_fp2.default.filter({ type: 'ruleset' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'include' }))(blockContent)));

    var extensions = _fp2.default.compose(_fp2.default.map('content'), _fp2.default.filter({ type: 'ident' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'parentSelectorExtension' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'selector' }))(rulesetsContent);

    if (!extensions.length) return [];

    var nestedExtensions = getExtensions(rulesetsContent);
    var result = extensions;
    if (nestedExtensions.length) {
      nestedExtensions.forEach(function (nestedExt) {
        extensions.forEach(function (ext) {
          result.push(ext + nestedExt);
        });
      });
    }

    return result;
  };

  ast.traverseByType('ruleset', function (node) {
    var classNames = _fp2.default.compose(_fp2.default.map('content'), _fp2.default.filter({ type: 'ident' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'class' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'selector' }))(node.content);

    if (!classNames.length) return;

    var extensions = getExtensions(node.content);
    if (!extensions.length) return;

    classNames.forEach(function (className) {
      extensions.forEach(function (ext) {
        classesMap[className + ext] = false;
      });

      // Ignore the base class if it only exists for nesting parent selectors
      var hasDeclarations = _fp2.default.compose(_fp2.default.filter({ type: 'declaration' }), _fp2.default.flatMap('content'), _fp2.default.filter({ type: 'block' }))(node.content).length > 0;
      if (!hasDeclarations) classesMap[className] = true;
    });
  });

  return classesMap;
};

/*
   mutates ast by removing instances of :global
 */
var eliminateGlobals = exports.eliminateGlobals = function eliminateGlobals(ast) {
  ast.traverse(function (node, index, parent) {
    if (node.type === 'ruleset') {
      if (_fp2.default.compose(_fp2.default.negate(_fp2.default.isEmpty), _fp2.default.find({ type: 'ident', content: 'global' }), _fp2.default.get('content'), _fp2.default.find({ type: 'pseudoClass' }), _fp2.default.get('content'), _fp2.default.find({ type: 'selector' }), _fp2.default.get('content'))(node)) {
        parent.removeChild(index);
      }
    }
  });
};

var getImportedFilePaths = exports.getImportedFilePaths = function getImportedFilePaths(ast, parentFilePath) {
  var filePaths = [];

  ast.traverse(function (node, index, parent) {
    if (node.type === 'atrule') {
      var filePath = node.content.find(function (node) {
        return node.type === 'string';
      }).content.replace(/^('|")/g, '').replace(/('|")$/, '');

      if (!filePath || filePath.startsWith('~')) return;

      filePaths.push(_path2.default.resolve(_path2.default.dirname(parentFilePath), filePath));
    }
  });

  return filePaths;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb3JlL3RyYXZlcnNhbFV0aWxzLmpzIl0sIm5hbWVzIjpbImdldFJlZ3VsYXJDbGFzc2VzTWFwIiwiYXN0IiwicnVsZVNldHMiLCJ0cmF2ZXJzZUJ5VHlwZSIsInB1c2giLCJub2RlIiwiY29tcG9zZSIsInJlZHVjZSIsInJlc3VsdCIsImtleSIsIm1hcCIsImZpbHRlciIsInR5cGUiLCJmbGF0TWFwIiwiZ2V0Q29tcG9zZXNDbGFzc2VzTWFwIiwiZGVjbGFyYXRpb25zIiwiZ2V0IiwiZmluZCIsInJlamVjdCIsImNvbnRlbnQiLCJnZXRFeHRlbmRDbGFzc2VzTWFwIiwiZXh0ZW5kTm9kZXMiLCJnZXRQYXJlbnRTZWxlY3RvckNsYXNzZXNNYXAiLCJjbGFzc2VzTWFwIiwiZ2V0RXh0ZW5zaW9ucyIsImJsb2NrQ29udGVudCIsIm5vZGVDb250ZW50IiwicnVsZXNldHNDb250ZW50IiwiY29uY2F0IiwiZXh0ZW5zaW9ucyIsImxlbmd0aCIsIm5lc3RlZEV4dGVuc2lvbnMiLCJmb3JFYWNoIiwiZXh0IiwibmVzdGVkRXh0IiwiY2xhc3NOYW1lcyIsImNsYXNzTmFtZSIsImhhc0RlY2xhcmF0aW9ucyIsImVsaW1pbmF0ZUdsb2JhbHMiLCJ0cmF2ZXJzZSIsImluZGV4IiwicGFyZW50IiwibmVnYXRlIiwiaXNFbXB0eSIsInJlbW92ZUNoaWxkIiwiZ2V0SW1wb3J0ZWRGaWxlUGF0aHMiLCJwYXJlbnRGaWxlUGF0aCIsImZpbGVQYXRocyIsImZpbGVQYXRoIiwicmVwbGFjZSIsInN0YXJ0c1dpdGgiLCJyZXNvbHZlIiwiZGlybmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7OztBQUZBO0FBVU8sSUFBTUEsc0RBQXVCLFNBQXZCQSxvQkFBdUIsQ0FBQ0MsR0FBRCxFQUFpQztBQUNuRSxNQUFNQyxXQUE0QixFQUFsQztBQUNBRCxNQUFJRSxjQUFKLENBQW1CLFNBQW5CLEVBQThCO0FBQUEsV0FBUUQsU0FBU0UsSUFBVCxD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ImZpbGUiOiJ0cmF2ZXJzYWxVdGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG4vKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuaW1wb3J0IGZwIGZyb20gJ2xvZGFzaC9mcCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHR5cGUgeyBnQVNUTm9kZSB9IGZyb20gJy4uL3R5cGVzJztcblxudHlwZSBjbGFzc01hcFR5cGUgPSB7XG4gIFtrZXk6IHN0cmluZ106IGJvb2xlYW4sXG59XG5cbmV4cG9ydCBjb25zdCBnZXRSZWd1bGFyQ2xhc3Nlc01hcCA9IChhc3Q6IGdBU1ROb2RlKTogY2xhc3NNYXBUeXBlID0+IHtcbiAgY29uc3QgcnVsZVNldHM6IEFycmF5PGdBU1ROb2RlPiA9IFtdO1xuICBhc3QudHJhdmVyc2VCeVR5cGUoJ3J1bGVzZXQnLCBub2RlID0+IHJ1bGVTZXRzLnB1c2gobm9kZSkpO1xuXG4gIHJldHVybiBmcC5jb21wb3NlKFxuICAgIGZwLnJlZHVjZSgocmVzdWx0LCBrZXkpID0+IHtcbiAgICAgIHJlc3VsdFtrZXldID0gZmFsc2U7IC8vIGNsYXNzZXMgaGF2ZW4ndCBiZWVuIHVzZWRcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwge30pLFxuICAgIGZwLm1hcCgnY29udGVudCcpLFxuICAgIGZwLmZpbHRlcih7IHR5cGU6ICdpZGVudCcgfSksXG4gICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICAgIGZwLmZpbHRlcih7IHR5cGU6ICdjbGFzcycgfSksXG4gICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICAgIGZwLmZpbHRlcih7IHR5cGU6ICdzZWxlY3RvcicgfSksXG4gICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICApKHJ1bGVTZXRzKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRDb21wb3Nlc0NsYXNzZXNNYXAgPSAoYXN0OiBnQVNUTm9kZSk6IGNsYXNzTWFwVHlwZSA9PiB7XG4gIGNvbnN0IGRlY2xhcmF0aW9ucyA9IFtdO1xuICBhc3QudHJhdmVyc2VCeVR5cGUoJ2RlY2xhcmF0aW9uJywgbm9kZSA9PiBkZWNsYXJhdGlvbnMucHVzaChub2RlKSk7XG5cbiAgcmV0dXJuIGZwLmNvbXBvc2UoXG4gICAgZnAucmVkdWNlKChyZXN1bHQsIGtleSkgPT4ge1xuICAgICAgcmVzdWx0W2tleV0gPSB0cnVlOyAvLyBtYXJrIGNvbXBvc2VkIGNsYXNzZXMgYXMgdHJ1ZVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7fSksXG4gICAgZnAuZmxhdE1hcChmcC5jb21wb3NlKFxuICAgICAgZnAubWFwKGZwLmdldCgnY29udGVudCcpKSxcbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdpZGVudCcgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbmQoeyB0eXBlOiAndmFsdWUnIH0pLFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgKSksXG4gICAgLypcbiAgICAgICByZWplY3QgY2xhc3NlcyBjb21wb3NpbmcgZnJvbSBvdGhlciBmaWxlc1xuICAgICAgIGVnLlxuICAgICAgIC5mb28ge1xuICAgICAgIGNvbXBvc2VzOiAuYmFyIGZyb20gJy4vb3RoZXJGaWxlJztcbiAgICAgICB9XG4gICAgICovXG4gICAgZnAucmVqZWN0KGZwLmNvbXBvc2UoXG4gICAgICBmcC5maW5kKHsgdHlwZTogJ2lkZW50JywgY29udGVudDogJ2Zyb20nIH0pLFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgICBmcC5maW5kKHsgdHlwZTogJ3ZhbHVlJyB9KSxcbiAgICAgIGZwLmdldCgnY29udGVudCcpLFxuICAgICkpLFxuICAgIGZwLmZpbHRlcihmcC5jb21wb3NlKFxuICAgICAgZnAuZmluZCh7IHR5cGU6ICdpZGVudCcsIGNvbnRlbnQ6ICdjb21wb3NlcycgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbmQoeyB0eXBlOiAncHJvcGVydHknIH0pLFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgKSksXG4gICkoZGVjbGFyYXRpb25zKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRFeHRlbmRDbGFzc2VzTWFwID0gKGFzdDogZ0FTVE5vZGUpOiBjbGFzc01hcFR5cGUgPT4ge1xuICBjb25zdCBleHRlbmROb2RlcyA9IFtdO1xuICBhc3QudHJhdmVyc2VCeVR5cGUoJ2V4dGVuZCcsIG5vZGUgPT4gZXh0ZW5kTm9kZXMucHVzaChub2RlKSk7XG5cbiAgcmV0dXJuIGZwLmNvbXBvc2UoXG4gICAgZnAucmVkdWNlKChyZXN1bHQsIGtleSkgPT4ge1xuICAgICAgcmVzdWx0W2tleV0gPSB0cnVlOyAvLyBtYXJrIGV4dGVuZCBjbGFzc2VzIGFzIHRydWVcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwge30pLFxuICAgIGZwLm1hcChmcC5jb21wb3NlKFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgICBmcC5maW5kKHsgdHlwZTogJ2lkZW50JyB9KSxcbiAgICAgIGZwLmdldCgnY29udGVudCcpLFxuICAgICAgZnAuZmluZCh7IHR5cGU6ICdjbGFzcycgfSksXG4gICAgICBmcC5nZXQoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbmQoeyB0eXBlOiAnc2VsZWN0b3InIH0pLFxuICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgKSksXG4gICkoZXh0ZW5kTm9kZXMpO1xufTtcblxuLyoqXG4gKiBSZXNvbHZlcyBwYXJlbnQgc2VsZWN0b3JzIHRvIHRoZWlyIGZ1bGwgY2xhc3MgbmFtZXMuXG4gKlxuICogRS5nLiBgLmZvbyB7ICZfYmFyIHtjb2xvcjogYmx1ZSB9IH1gIHRvIGAuZm9vX2JhcmAuXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRQYXJlbnRTZWxlY3RvckNsYXNzZXNNYXAgPSAoYXN0OiBnQVNUTm9kZSk6IGNsYXNzTWFwVHlwZSA9PiB7XG4gIGNvbnN0IGNsYXNzZXNNYXA6IGNsYXNzTWFwVHlwZSA9IHt9O1xuXG4gIC8vIFJlY3Vyc2l2ZWx5IHRyYXZlcnNlcyBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIHBhcmVudCBzZWxlY3RvclxuICAvLyBleHRlbnNpb25zLiBSZWN1cnNpb24gaXMgbmVjZXNzYXJ5IGFzIHRoZXNlIHNlbGVjdG9ycyBjYW4gYmUgbmVzdGVkLlxuICBjb25zdCBnZXRFeHRlbnNpb25zID0gbm9kZUNvbnRlbnQgPT4ge1xuICAgIGNvbnN0IGJsb2NrQ29udGVudCA9IGZwLmNvbXBvc2UoXG4gICAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnYmxvY2snIH0pXG4gICAgKShub2RlQ29udGVudCk7XG5cbiAgICBjb25zdCBydWxlc2V0c0NvbnRlbnQgPSBmcC5mbGF0TWFwKCdjb250ZW50JywgZnAuY29uY2F0KFxuICAgICAgLy8gYHJ1bGVzZXRgIGNoaWxkcmVuXG4gICAgICBmcC5maWx0ZXIoeyB0eXBlOiAncnVsZXNldCcgfSwgYmxvY2tDb250ZW50KSxcblxuICAgICAgLy8gYHJ1bGVzZXRgIGRlc2NlbmRhbnRzIG5lc3RlZCBpbiBgaW5jbHVkZWAgbm9kZXNcbiAgICAgIGZwLmNvbXBvc2UoXG4gICAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdydWxlc2V0JyB9KSxcbiAgICAgICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICAgICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnYmxvY2snIH0pLFxuICAgICAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdpbmNsdWRlJyB9KVxuICAgICAgKShibG9ja0NvbnRlbnQpXG4gICAgKSk7XG5cbiAgICBjb25zdCBleHRlbnNpb25zID0gZnAuY29tcG9zZShcbiAgICAgIGZwLm1hcCgnY29udGVudCcpLFxuICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ2lkZW50JyB9KSxcbiAgICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdwYXJlbnRTZWxlY3RvckV4dGVuc2lvbicgfSksXG4gICAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnc2VsZWN0b3InIH0pXG4gICAgKShydWxlc2V0c0NvbnRlbnQpO1xuXG4gICAgaWYgKCFleHRlbnNpb25zLmxlbmd0aCkgcmV0dXJuIFtdO1xuXG4gICAgY29uc3QgbmVzdGVkRXh0ZW5zaW9ucyA9IGdldEV4dGVuc2lvbnMocnVsZXNldHNDb250ZW50KTtcbiAgICBjb25zdCByZXN1bHQgPSBleHRlbnNpb25zO1xuICAgIGlmIChuZXN0ZWRFeHRlbnNpb25zLmxlbmd0aCkge1xuICAgICAgbmVzdGVkRXh0ZW5zaW9ucy5mb3JFYWNoKG5lc3RlZEV4dCA9PiB7XG4gICAgICAgIGV4dGVuc2lvbnMuZm9yRWFjaChleHQgPT4ge1xuICAgICAgICAgIHJlc3VsdC5wdXNoKGV4dCArIG5lc3RlZEV4dCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICBhc3QudHJhdmVyc2VCeVR5cGUoJ3J1bGVzZXQnLCBub2RlID0+IHtcbiAgICBjb25zdCBjbGFzc05hbWVzID0gZnAuY29tcG9zZShcbiAgICAgIGZwLm1hcCgnY29udGVudCcpLFxuICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ2lkZW50JyB9KSxcbiAgICAgIGZwLmZsYXRNYXAoJ2NvbnRlbnQnKSxcbiAgICAgIGZwLmZpbHRlcih7IHR5cGU6ICdjbGFzcycgfSksXG4gICAgICBmcC5mbGF0TWFwKCdjb250ZW50JyksXG4gICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnc2VsZWN0b3InIH0pXG4gICAgKShub2RlLmNvbnRlbnQpO1xuXG4gICAgaWYgKCFjbGFzc05hbWVzLmxlbmd0aCkgcmV0dXJuO1xuXG4gICAgY29uc3QgZXh0ZW5zaW9ucyA9IGdldEV4dGVuc2lvbnMobm9kZS5jb250ZW50KTtcbiAgICBpZiAoIWV4dGVuc2lvbnMubGVuZ3RoKSByZXR1cm47XG5cbiAgICBjbGFzc05hbWVzLmZvckVhY2goY2xhc3NOYW1lID0+IHtcbiAgICAgIGV4dGVuc2lvbnMuZm9yRWFjaChleHQgPT4ge1xuICAgICAgICBjbGFzc2VzTWFwW2NsYXNzTmFtZSArIGV4dF0gPSBmYWxzZTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBJZ25vcmUgdGhlIGJhc2UgY2xhc3MgaWYgaXQgb25seSBleGlzdHMgZm9yIG5lc3RpbmcgcGFyZW50IHNlbGVjdG9yc1xuICAgICAgY29uc3QgaGFzRGVjbGFyYXRpb25zID0gZnAuY29tcG9zZShcbiAgICAgICAgZnAuZmlsdGVyKHsgdHlwZTogJ2RlY2xhcmF0aW9uJyB9KSxcbiAgICAgICAgZnAuZmxhdE1hcCgnY29udGVudCcpLFxuICAgICAgICBmcC5maWx0ZXIoeyB0eXBlOiAnYmxvY2snIH0pXG4gICAgICApKG5vZGUuY29udGVudCkubGVuZ3RoID4gMDtcbiAgICAgIGlmICghaGFzRGVjbGFyYXRpb25zKSBjbGFzc2VzTWFwW2NsYXNzTmFtZV0gPSB0cnVlO1xuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gY2xhc3Nlc01hcDtcbn07XG5cbi8qXG4gICBtdXRhdGVzIGFzdCBieSByZW1vdmluZyBpbnN0YW5jZXMgb2YgOmdsb2JhbFxuICovXG5leHBvcnQgY29uc3QgZWxpbWluYXRlR2xvYmFscyA9IChhc3Q6IGdBU1ROb2RlKSA9PiB7XG4gIGFzdC50cmF2ZXJzZSgobm9kZSwgaW5kZXgsIHBhcmVudCkgPT4ge1xuICAgIGlmIChub2RlLnR5cGUgPT09ICdydWxlc2V0Jykge1xuICAgICAgaWYgKFxuICAgICAgICBmcC5jb21wb3NlKFxuICAgICAgICAgIGZwLm5lZ2F0ZShmcC5pc0VtcHR5KSxcbiAgICAgICAgICBmcC5maW5kKHsgdHlwZTogJ2lkZW50JywgY29udGVudDogJ2dsb2JhbCcgfSksXG4gICAgICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgICAgICAgZnAuZmluZCh7IHR5cGU6ICdwc2V1ZG9DbGFzcycgfSksXG4gICAgICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgICAgICAgZnAuZmluZCh7IHR5cGU6ICdzZWxlY3RvcicgfSksXG4gICAgICAgICAgZnAuZ2V0KCdjb250ZW50JyksXG4gICAgICAgICkobm9kZSlcbiAgICAgICkge1xuICAgICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQoaW5kZXgpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0SW1wb3J0ZWRGaWxlUGF0aHMgPSAoYXN0OiBnQVNUTm9kZSwgcGFyZW50RmlsZVBhdGg6IHN0cmluZykgPT4ge1xuICBjb25zdCBmaWxlUGF0aHMgPSBbXTtcblxuICBhc3QudHJhdmVyc2UoKG5vZGUsIGluZGV4LCBwYXJlbnQpID0+IHtcbiAgICBpZiAobm9kZS50eXBlID09PSAnYXRydWxlJykge1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBub2RlLmNvbnRlbnQuZmluZChub2RlID0+IG5vZGUudHlwZSA9PT0gJ3N0cmluZycpXG4gICAgICAgIC5jb250ZW50XG4gICAgICAgIC5yZXBsYWNlKC9eKCd8XCIpL2csICcnKS5yZXBsYWNlKC8oJ3xcIikkLywgJycpO1xuXG4gICAgICBpZiAoIWZpbGVQYXRoIHx8IGZpbGVQYXRoLnN0YXJ0c1dpdGgoJ34nKSkgcmV0dXJuO1xuXG4gICAgICBmaWxlUGF0aHMucHVzaChwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKHBhcmVudEZpbGVQYXRoKSwgZmlsZVBhdGgpKTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBmaWxlUGF0aHM7XG59XG4iXX0=